---
# check whether java is installed
- name: determine if Java is already installed
  shell: which java
  register: java_task_installed
  changed_when: java_task_installed.rc != 0
  failed_when: no

# Update Cache of the System
- name: Update Cache
  become: true
  apt:
   update_cache: yes
   cache_valid_time: 84600
   dpkg_options: 'force-confold,force-confdef'
  tags: update_cache

# Install Java Kit
- name: Ensure Java Development Kit is Installed
  become: true
  apt: name=openjdk-7-jdk state=present
  tags: java_installation

# make a tomcat group
- name: make a tomcat group
  group:
    name: tomcat
    state: present
  become: true 
  tags: tomcat_group

#  check whether if tomcat use is already present or not
#- name: check whether a user tomcat exists
#  shell: "grep -c '^tomcat:' /etc/passwd"
#  register: default_user

- name: make a tomcat user if not present already and make it owner of tomcat group 
  user:
    name=tomcat
    shell=/bin/bash
    groups=tomcat
    append=yes
#    when: default_user.stdout == 0
  tags: tomcat_user
  

# download Tomcat and store it into /tmp folder
- name: Download Tomcat and save it into /tmp folder
  become: true
  get_url:
    url: "{{ tomcat8_package_url }}"
    dest: /tmp/
  tags: tomcat_download  

# make a tomcat named folder into /opt for our tomcat installation
- name:  Make a directory for Tomcat & extract into a particular folder
  file:
    path: /opt/tomcat/
    state: directory
    owner: tomcat
    group: tomcat
    mode: 0775
  become: true
  tags: directory_creation

# unarchive the downloaded tar file
- unarchive:
    remote_src: true
    src: /tmp/apache-tomcat-8.5.16.tar.gz
    dest: /opt/tomcat/
  tags: tomcat_installation

# get Java Home path 
- name: get the JAVA_HOME path
  shell: sudo update-java-alternatives -l | awk '{print $3}'
  register: JAVA_HOME
  tags: getting_java_home

# make a directory for Tomcat Server and User Files
- name:  Make a directory for Tomcat Server and User Files
  file:
    path: /etc/tomcat
    state: directory
    owner: tomcat
    group: tomcat
    mode: 0775
  tags: directory_creation

# Copy Tomcat.service file in order to make it a service
- name: copy tomcat.service file
  template: 
    src: "{{ tomcat_service }}" 
    dest: /etc/systemd/system/tomcat.service  
    owner: tomcat 
    group: tomcat
  become: true
  tags: copying_tomcat_service  

# copy tomcat server.xml file
- name: copy the tomcat8 server file
  template: 
    src: "{{ server }}"
    dest: /etc/tomcat/  
    owner: tomcat  
    group: tomcat 
  become: true
  tags: copying_server_xml

# copy tomcat user.xml file
- name: copy the tomcat8 users file
  template: 
    src: "{{ tomcat_users }}" 
    dest: /etc/tomcat/  
    owner: tomcat  
    group: tomcat
  become: true
  notify:
   - restart_tomcat8
  tags: copying_user_xml

